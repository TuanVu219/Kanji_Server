<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://www.google.com/favicon.ico">
  <title>Realtime Drawing Recognizer</title>

  <style>
    body {
      text-align: center;
      background-color: #121212;
      color: white;
      font-family: monospace;
    }
    #canvas {
      border: 2px solid #888;
      background-color: black;
      margin-top: 20px;
      cursor: crosshair;
    }
    #predictions {
      margin-top: 20px;
      font-size: 16px;
    }
    button {
      margin: 5px;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #555;
    }
  </style>
</head>

<body>
  <h2>Realtime Drawing Recognizer ðŸŽ¨</h2>

  <canvas id="canvas" width="500" height="400"></canvas>
  <br />
  <button id="clear">Clear</button>

  <div id="predictions"></div>

  <script>
    // =====================
    // CANVAS SETUP
    // =====================
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let drawing = false;
    let currentStroke = [];
    let allStrokes = [];

    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#fff";

    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // =====================
    // WEBSOCKET SETUP
    // =====================
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws_url = `${ws_scheme}://${window.location.host}/ws/recognize/`;
    const ws = new WebSocket(ws_url);

    ws.onopen = () => {
      console.log("âœ… WebSocket connected:", ws_url);
    };

    ws.onclose = () => {
      console.log("ðŸ”Œ WebSocket closed");
    };

    ws.onerror = (err) => {
      console.error("âš ï¸ WebSocket error:", err);
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.status === "predictions") {
        displayPredictions(data.predictions);
      }
    };

    // =====================
    // DRAW EVENTS
    // =====================
    canvas.addEventListener("mousedown", () => {
      drawing = true;
      currentStroke = [];
      ctx.beginPath();
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!drawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.lineTo(x, y);
      ctx.stroke();

      currentStroke.push([x, y]);
    });

    canvas.addEventListener("mouseup", () => {
      if (!drawing) return;
      drawing = false;

      if (currentStroke.length > 0) {
        allStrokes.push(currentStroke);
        sendStroke(currentStroke);
      }
    });

    canvas.addEventListener("mouseleave", () => {
      drawing = false;
    });

    // =====================
    // SEND STROKE
    // =====================
    function sendStroke(stroke) {
      if (ws.readyState !== WebSocket.OPEN) return;

      ws.send(
        JSON.stringify({
          action: "strokes",
          stroke: stroke,
          canvas_size: {
            width: canvas.width,
            height: canvas.height,
          },
        })
      );
    }

    // =====================
    // CLEAR CANVAS
    // =====================
    document.getElementById("clear").addEventListener("click", () => {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      allStrokes = [];

      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: "clear" }));
      }

      document.getElementById("predictions").innerHTML = "";
    });

    // =====================
    // DISPLAY PREDICTIONS
    // =====================
    function displayPredictions(predictions) {
      const container = document.getElementById("predictions");
      container.innerHTML = "";

      const topKPerStroke = predictions.map(p => p.topk.slice(0, 5));

      const cartesian = (arr) =>
        arr.reduce(
          (a, b) => a.flatMap(d => b.map(e => [...d, e])),
          [[]]
        );

      const combos = cartesian(topKPerStroke)
        .map(combo => ({
          chars: combo.map(c => c.label).join(""),
          prob: combo.reduce((p, c) => p * c.prob, 1),
        }))
        .sort((a, b) => b.prob - a.prob)
        .slice(0, 5);

      combos.forEach((c, i) => {
        const div = document.createElement("div");
        div.textContent = `#${i + 1}: ${c.chars}`;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
